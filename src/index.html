<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mohr's circle</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

  <style>
    #svgScene {
      border: 1px solid hsl(0, 20%, 96%);
      width: 700px;
      height: 700px;
    }

    .grid line {
      stroke: lightgray;
      stroke-opacity: 0.7;
      shape-rendering: crispEdges;
    }

    .grid path {
      stroke-width: 0;
    }

    .container{
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="row">
      <div class="col-md-8">
        <h2>Mohr's circle</h2>
      </div>
      <div class="col-md-4">
        <h5>Settings</h5>
      </div>
    </div>
    <div class="row">
      <div class="col-md-8">
        <svg id="svgScene"></svg>
      </div>
      <div class="col-md-4">
        <form>
          <div class="form-group">
            <label for="numberInput">X stress</label>
            <input type="number" class="form-control" id="Xstress" value="100">
          </div>
          <div class="form-group">
            <label for="numberInput">Y stress</label>
            <input type="number" class="form-control" id="Ystress" value="20">
          </div>
          <div class="form-group">
            <label for="numberInput">Shear stress</label>
            <input type="number" class="form-control" id="ShearStress" value="5">
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <script>
    const svgScene = d3.select("#svgScene");
    const xScale = d3.scaleLinear();
    const yScale = d3.scaleLinear();

    subscribeToInputsEvent();
    reDrawMohrChart();

    function reDrawAxis(center, radius) {
      const chSett = {
        width: 700,
        height: 700,
        margin: 20,
        domainLengthFromX: -10,
        domainLengthFromY: -100,
        domainLengthTo: 100,
        domainMinMargin: -10,
        domainMaxMargin: 10,
      };

      const minValue = center - radius;
      const maxValue = center + radius;
      const domainMinX = minValue < chSett.domainMinMargin ? minValue + chSett.domainMinMargin : chSett.domainMinMargin;
      const domainMaxX = maxValue > chSett.domainMaxMargin ? maxValue + chSett.domainMaxMargin : chSett.domainMaxMargin;
      
      svgScene.selectAll("*").remove();  

      xScale
      .domain([domainMinX, domainMaxX])
      .range([chSett.margin, chSett.width - chSett.margin]);

      yScale
      .domain([chSett.domainLengthFromY, chSett.domainLengthTo])
      .range([chSett.height - chSett.margin, chSett.margin]);

      svgScene.append("g")
      .attr("transform", `translate(0,${yScale(0)})`)
      .call(d3.axisBottom(xScale));

      svgScene.append("g")
        .attr("transform", `translate(${xScale(0)},0)`)
        .call(d3.axisLeft(yScale));

      drawChartMesh(chSett.height, chSett.width, chSett.margin);   
    }

    function drawChartMesh(height, width, margin) {
      svgScene.append("g")
        .attr("class", "grid grid-y")
        .attr("transform", `translate(${margin}, 0)`)
        .call(
          d3.axisLeft(yScale)
            .tickSize(-(width - margin - margin)) 
            .tickFormat("")
      );

      svgScene.append("g")
        .attr("class", "grid grid-x")
        .attr("transform", `translate(0, ${height - margin})`)
        .call(
          d3.axisBottom(xScale)
            .tickSize(-(height - margin - margin))
            .tickFormat("")
      );
    }

    function subscribeToInputsEvent() {
      document.getElementById('Xstress').addEventListener('input', () => reDrawMohrChart());
      document.getElementById('Xstress').addEventListener('input', () => reDrawMohrChart());
      document.getElementById('ShearStress').addEventListener('input', () => reDrawMohrChart());
    }

    function reDrawMohrChart() {
      const xInput = document.getElementById('Xstress');
      const yInput = document.getElementById('Ystress');
      const shearInput = document.getElementById('ShearStress');

      const xValue = parseFloat(xInput.value) || 0;
      const yValue = parseFloat(yInput.value) || 0;
      const tauXY = parseFloat(shearInput.value) || 0;

      const center = (xValue + yValue) / 2;
      const radius = Math.sqrt(Math.pow((xValue - yValue) / 2, 2) + Math.pow(tauXY, 2));

      reDrawAxis(center, radius);
      drawMohrCircle(center, radius);
    }

    function drawMohrCircle(centerX, radius) {
      const scaleCenterX = xScale(centerX);
      const scaleCenterY = yScale(0);
      const scaleRadius = xScale(centerX + radius) - xScale(centerX);

      svgScene.append("circle")
        .attr("cx", scaleCenterX)
        .attr("cy", scaleCenterY)
        .attr("r", scaleRadius)
        .attr("fill", "none")
        .attr("stroke", "black")
        .attr("stroke-width", 1);

      drawDotWithLabel(scaleCenterX + scaleRadius, scaleCenterY, `σ₁= ${round(centerX + radius)}`);
      drawDotWithLabel(scaleCenterX - scaleRadius, scaleCenterY, `σ₂= ${round(centerX - radius)}`);
      drawDotWithLabel(scaleCenterX, scaleCenterY - scaleRadius, `τmax= ${round(radius)}`);
      drawDotWithLabel(scaleCenterX, scaleCenterY + scaleRadius, `τmin= -${round(radius)}`);
    }

    function drawDotWithLabel(locationX, locationY, text) {
      const labelMargin = 10;
      
      svgScene.append("text")
        .attr("x", locationX + labelMargin)
        .attr("y", locationY - labelMargin)
        .text(text)
        .attr("font-size", "14px")
        .attr("fill", "black");

      svgScene.append("circle")
        .attr("cx", locationX)
        .attr("cy", locationY)
        .attr("r", 3)
        .attr("fill", "black");
    }

    function round(num) {
      return Number(num.toFixed(2));
    }

  </script>
</body>
</html>